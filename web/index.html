<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ROS2 AUTONAV WEBUI</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="page-shell">
        <header class="topbar">
            <div class="brand">
                <span class="brand-dot"></span>
                <span class="brand-title">ROS2 AUTONAV WEBUI</span>
            </div>
            <div class="topbar-status">
                <span class="chip" id="ros-domain-chip">ROS DOMAIN ID: 0</span>
                <span class="chip chip-soft">Web: 8080</span>
                <span class="chip chip-soft">rosbridge: 9090</span>
                <span class="chip chip-soft" id="latency-indicator">latency: --ms</span>
            </div>
        </header>

        <div class="tab-navigation card">
            <button class="tab-button active" onclick="openTab('slam-tab')">SLAM/Localization</button>
            <button class="tab-button" onclick="openTab('player-tab')">Data Player/Recorder</button>
            <button class="tab-button" onclick="openTab('visualization-tab')">Visualization</button>
        </div>

        <!-- SLAM/Localization Tab -->
        <div id="slam-tab" class="tab-content active">
            <div class="subtab-navigation card">
                <button class="subtab-button active" onclick="openSubTab('lidar-slam-subtab')">LiDAR SLAM</button>
                <button class="subtab-button" onclick="openSubTab('localization-subtab')">Localization</button>
                <button class="subtab-button" onclick="openSubTab('multi-session-slam-subtab')">Multi-Session SLAM</button>
            </div>

            <!-- LiDAR SLAM Sub-Tab -->
            <div id="lidar-slam-subtab" class="subtab-content active">
                <div class="section card">
                    <h2>LiDAR SLAM</h2>

                    <!-- Config Parameters Display -->
                    <div id="slam-config-container" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: center; position: relative;">
                            <h3 style="text-align: center;">SLAM Configuration Parameters</h3>
                            <button id="slam-config-toggle-btn" class="collapse-toggle-btn" onclick="toggleSlamConfig()" style="position: absolute; right: 0;">▲</button>
                        </div>
                        <div class="separator"></div>
                        <div id="slam-config-parameters">
                            <!-- Parameters will be dynamically loaded here -->
                        </div>
                        <div class="separator"></div>
                    </div>

                    <div class="bag-control-buttons" style="margin-bottom: 15px;">
                        <button onclick="loadSlamConfig()">Config Load</button>
                        <button id="slam-save-button" onclick="saveSlamConfig()">Set Config File</button>
                        <button id="slam-save-map-button" onclick="saveSlamMap()">Save Map</button>
                        <button id="slam-start-button" onclick="startSlamMapping()">Start SLAM</button>
                        <button id="slam-stop-button" onclick="stopSlamMapping()">Stop SLAM</button>
                    </div>

                    <div class="separator"></div>

                    <div class="status">
                        <label id="lidar-slam-status">Status: Ready</label>
                    </div>

                </div>
            </div>

            <!-- Localization Sub-Tab -->
            <div id="localization-subtab" class="subtab-content">
                <div class="section card">
                    <h2>Localization</h2>

                    <!-- Config Parameters Display -->
                    <div id="localization-config-container" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: center; position: relative;">
                            <h3 style="text-align: center;">Localization Configuration Parameters</h3>
                            <button id="localization-config-toggle-btn" class="collapse-toggle-btn" onclick="toggleLocalizationConfig()" style="position: absolute; right: 0;">▲</button>
                        </div>
                        <div class="separator"></div>
                        <div id="localization-config-parameters">
                            <!-- Parameters will be dynamically loaded here -->
                        </div>
                        <div class="separator"></div>
                    </div>

                    <div class="bag-control-buttons" style="margin-bottom: 15px;">
                        <button onclick="loadLocalizationConfig()">Config Load</button>
                        <button id="localization-save-button" onclick="saveLocalizationConfig()">Set Config File</button>
                        <button id="localization-start-button" onclick="startLocalizationMapping()">Start Localization</button>
                        <button id="localization-stop-button" onclick="stopLocalizationMapping()">Stop Localization</button>
                    </div>

                    <div class="separator"></div>

                    <div class="status">
                        <label id="localization-status">Status: Ready</label>
                    </div>

                </div>
            </div>

            <!-- Multi-Session SLAM Sub-Tab -->
            <div id="multi-session-slam-subtab" class="subtab-content">
                <div class="section card">
                    <h2>Multi-Session SLAM</h2>

                    <div class="form-group">
                        <label>Map 1:</label>
                        <input type="text" id="slam-map1" placeholder="Click Load Map 1 to browse" readonly>
                        <button onclick="loadMap1()">Load Map 1</button>
                    </div>

                    <div class="form-group">
                        <label>Map 2:</label>
                        <input type="text" id="slam-map2" placeholder="Click Load Map 2 to browse" readonly>
                        <button onclick="loadMap2()">Load Map 2</button>
                    </div>

                    <div class="form-group">
                        <label>Output:</label>
                        <input type="text" id="slam-output" placeholder="Enter directory name (e.g., result)">
                        <button onclick="setOutput()">Set Output</button>
                    </div>

                    <div class="separator"></div>

                    <div class="status">
                        <label id="slam-status">Status: Ready</label>
                    </div>

                    <div class="separator"></div>

                    <div class="action-buttons center">
                        <button class="primary-button" onclick="runOptimization()">Multi Session Optimization</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Player/Recorder Tab -->
        <div id="player-tab" class="tab-content">
            <div class="subtab-navigation card">
                <button class="subtab-button active" onclick="openSubTab('bag-player-subtab')">Bag Player</button>
                <button class="subtab-button" onclick="openSubTab('bag-recorder-subtab')">Bag Recorder</button>
                <button class="subtab-button" onclick="openSubTab('file-player-subtab')">File Player</button>
            </div>

            <!-- Bag Player Sub-Tab -->
            <div id="bag-player-subtab" class="subtab-content active">
                <div class="section card">
                    <h2>Bag Player</h2>

                    <div class="form-group">
                        <label>Bag Directory:</label>
                        <input type="text" id="bag-directory" placeholder="Click Load Bag File to browse" readonly>
                        <button onclick="loadBagFile()">Load Bag File</button>
                    </div>

                    <div class="form-group">
                        <label>Selected Topics:</label>
                        <div id="bag-selected-topics-display" style="padding: 5px; background: #3a3a3a; border-radius: 4px; margin-bottom: 10px; min-height: 25px;">
                            <span style="color: #888;">No topics selected</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label></label>
                        <div class="bag-control-buttons">
                            <button onclick="selectTopics()">Select Topic</button>
                            <button id="bag-play-button" onclick="playBag()">Play</button>
                            <button id="bag-pause-button" onclick="pauseBag()">Pause</button>
                        </div>
                        <div></div>
                    </div>

                    <div class="separator"></div>

                    <div class="bag-timeline">
                        <label id="bag-time-label">0:00 / 0:00</label>
                        <div class="slider-container">
                            <input type="range" id="bag-slider" min="0" max="10000" value="0" onchange="setBagPosition(this.value)">
                        </div>
                    </div>

                </div>
            </div>

            <!-- Bag Recorder Sub-Tab -->
            <div id="bag-recorder-subtab" class="subtab-content">
                <div class="section card">
                    <h2>Bag Recorder</h2>

                    <div class="form-group">
                        <label>Bag Name:</label>
                        <input type="text" id="recorder-bag-name" placeholder="Enter bag name">
                        <button onclick="enterBagName()">Enter Bag Name</button>
                    </div>

                    <div class="form-group">
                        <label>Selected Topics:</label>
                        <div id="recorder-selected-topics-display" style="padding: 5px; background: #3a3a3a; border-radius: 4px; margin-bottom: 10px; min-height: 25px;">
                            <span style="color: #888;">No topics selected</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label></label>
                        <div class="bag-control-buttons">
                            <button onclick="selectRecorderTopics()">Select Topic</button>
                            <button id="recorder-record-button" onclick="recordBag()">Record</button>
                        </div>
                        <div></div>
                    </div>

                </div>
            </div>

            <!-- File Player Sub-Tab -->
            <div id="file-player-subtab" class="subtab-content">
                <div class="section card">
                    <h2>ConPR File Player</h2>

                    <div class="player-controls">
                        <div class="player-grid">
                            <label id="player-path-label"></label>
                            <button onclick="loadPlayerPath()">Load</button>
                            <button onclick="saveBag()">Save bag</button>

                            <label id="player-timestamp-label">0</label>
                            <button id="play-button" onclick="playPlayer()">Play</button>
                            <button id="pause-button" onclick="pausePlayer()">Pause</button>
                        </div>
                    </div>

                    <div class="separator"></div>

                    <div class="player-options">
                        <label>
                            <input type="checkbox" id="player-loop" onchange="setLoop(this.checked)">
                            Loop
                        </label>
                        <label>
                            <input type="checkbox" id="player-skip-stop" checked onchange="setSkipStop(this.checked)">
                            Skip stop section
                        </label>
                        <label>
                            <input type="checkbox" id="player-auto-start" onchange="setAutoStart(this.checked)">
                            Auto start
                        </label>

                        <div class="speed-control">
                            <label>Speed:</label>
                            <input type="number" id="player-speed" value="1.0" min="0.1" max="20.0" step="0.1" oninput="setSpeed(this.value)">
                        </div>
                    </div>

                    <div class="separator"></div>

                    <div class="slider-container">
                        <input type="range" id="player-slider" min="0" max="10000" value="0" onchange="setSliderPosition(this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualization Tab -->
        <div id="visualization-tab" class="tab-content">
            <div class="subtab-navigation card">
                <button class="subtab-button active" onclick="openSubTab('plot-subtab')">Plot</button>
                <button class="subtab-button" onclick="openSubTab('3d-viewer-subtab')">3D Viewer</button>
            </div>

            <!-- Plot Sub-Tab -->
            <div id="plot-subtab" class="subtab-content active">
                <div class="section card">
                    <h2>Plot</h2>
                    <div class="plot-container">
                        <!-- 왼쪽 Display 창 (통합 트리 뷰) -->
                        <div class="plot-display-panel">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3>Timeseries List</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="expandAllPlotTree()" style="padding: 4px 12px; font-size: 11px;">Expand All</button>
                                    <button onclick="collapseAllPlotTree()" style="padding: 4px 12px; font-size: 11px;">Collapse All</button>
                                </div>
                            </div>
                            <!-- 검색창 -->
                            <div style="margin-bottom: 12px;">
                                <input type="text" id="plot-search-input" placeholder="Search by name for topics..." 
                                       style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; color: var(--text);"
                                       oninput="filterPlotTree(this.value)">
                            </div>
                            <!-- 통합 트리 (토픽 + 메시지) -->
                            <div id="plot-tree" style="overflow-y: auto; max-height: 600px;">
                                <div style="color: var(--muted); padding: 12px; text-align: center;">
                                    Loading topics...
                                </div>
                            </div>
                        </div>
                        <!-- 오른쪽 Plot 영역 -->
                        <div class="plot-panel">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0;">Plot Area</h3>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label for="buffer-time-input" style="font-size: 12px; color: var(--text);">Buffer:</label>
                                    <input type="number" id="buffer-time-input" min="1" max="100" value="5" step="1"
                                           style="width: 60px; padding: 4px 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px;"
                                           onchange="updateBufferTime(this.value)"
                                           title="일시정지 시 모든 데이터를 표시합니다. 고주파 센서(100Hz+)는 60초 이하 권장.">
                                    <span style="font-size: 12px; color: var(--muted);">sec</span>
                                </div>
                            </div>
                            <div id="plot-tab-bar-container"></div>
                            <div id="plot-area-container" style="position: relative; width: 100%; height: 550px;">
                                <!-- plot-area-tab-1, plot-area-tab-2, ... dynamically generated -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3D Viewer Sub-Tab -->
            <div id="3d-viewer-subtab" class="subtab-content">
                <div class="section card">
                    <h2>3D Viewer</h2>
                    <div id="3d-viewer-container" style="width: 100%; height: 600px; background: #2a2a2a; border-radius: 8px; position: relative; overflow: hidden;">
                        <!-- Three.js canvas will be inserted here -->
                        <div id="3d-viewer-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 14px;">
                            Initializing 3D Viewer...
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <button onclick="selectDisplayTopics()">Select PointCloud2 Topics</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div id="file-browser-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select File or Directory</h3>
                <span class="close" onclick="closeFileBrowser()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="current-path">
                    <strong>Current Path:</strong> <span id="current-path-display">/home</span>
                </div>
                <div class="directory-list" id="directory-list">
                    <!-- Directory and file entries will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="selectCurrentDirectory()">Select This Directory</button>
                <button onclick="closeFileBrowser()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Topic Selection Modal -->
    <div id="topic-selection-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Topics</h3>
                <span class="close" onclick="closeTopicSelection()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="topic-list" id="topic-list">
                    <!-- Topic checkboxes will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="confirmTopicSelection()">Confirm</button>
                <button onclick="closeTopicSelection()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Recorder Topic Selection Modal -->
    <div id="recorder-topic-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Topics to Record</h3>
                <span class="close" onclick="closeRecorderTopicSelection()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="topic-list" id="recorder-topic-list">
                    <!-- Recorder topic checkboxes will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="confirmRecorderTopicSelection()">Confirm</button>
                <button onclick="closeRecorderTopicSelection()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- 3D Viewer Topic Selection Modal -->
    <div id="display-topic-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select PointCloud2 Topics</h3>
                <span class="close" onclick="closeDisplayTopicSelection()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="topic-list" id="display-topic-list">
                    <!-- Display topic checkboxes will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="confirmDisplayTopicSelection()">Confirm</button>
                <button onclick="closeDisplayTopicSelection()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Save Map Modal -->
    <div id="save-map-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Save Map</h3>
                <span class="close" onclick="closeSaveMapModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Directory Name:</label>
                    <input type="text" id="save-map-directory" placeholder="Enter directory name (e.g., map_2024)">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="confirmSaveMap()">OK</button>
                <button onclick="closeSaveMapModal()">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Import Map for Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
        }
    }
    </script>

    <!-- ROSLIB -->
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.1.0/build/roslib.min.js"></script>

    <!-- Plotly.js for Plot visualization -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- PlotJugglerTree -->
    <script src="static/plot_tree.js"></script>
    
    <!-- Plot Tab Manager (PlotTabManager) -->
    <script src="static/plot_tab_manager.js"></script>
    
    <!-- Plot Manager (DataBuffer, PlotlyPlotManager) -->
    <script src="static/plot_manager.js"></script>
    
    <script src="static/script.js"></script>
    
    <!-- Three.js and OrbitControls as ES6 modules -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // Make THREE and OrbitControls globally available
        window.THREE = THREE;
        window.OrbitControls = OrbitControls;
        window.threeReady = true;
        window.orbitControlsReady = true;
        
        console.log('Three.js and OrbitControls loaded successfully');
        console.log('THREE:', typeof window.THREE);
        console.log('OrbitControls:', typeof window.OrbitControls);
        
        // Trigger initialization if 3D Viewer is already active
        if (window.threejsDisplayReady) {
            window.threejsDisplayReady();
        }
        
        // Also trigger if initialize3DViewer is waiting
        if (window.waitingForThree) {
            window.waitingForThree();
        }
    </script>
    
    <!-- Three.js Display Script -->
    <script src="static/threejs_display.js"></script>
</body>
</html>
